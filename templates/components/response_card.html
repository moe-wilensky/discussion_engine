<div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
    <div class="flex justify-between items-start mb-3">
        <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
                <span class="font-medium">Response #{{ response.response_number }}</span>
                <span class="text-sm text-gray-500">by {{ response.user.username }}</span>
                {% if response.is_edited %}
                <span class="text-xs text-gray-400">(edited)</span>
                {% endif %}
            </div>
            <div class="text-sm text-gray-600 mb-1">
                {{ response.created_at|date:"M d, Y H:i" }}
            </div>
        </div>
        <div class="text-xs text-gray-500">
            {{ response.character_count }} chars
        </div>
    </div>
    
    <!-- Quoted Response (if any) -->
    {% if response.quoted_response %}
    <div class="bg-blue-50 border-l-4 border-blue-400 pl-3 py-2 mb-3 text-sm rounded">
        <div class="flex items-center text-blue-700 text-xs mb-1">
            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
            Quoting @{{ response.quoted_response.user.username }} (Response #{{ response.quoted_response.response_number }}):
        </div>
        <blockquote class="text-gray-700 italic">
            {% if response.quote_text %}
                "{{ response.quote_text|truncatewords:50 }}"
            {% else %}
                "{{ response.quoted_response.content|truncatewords:50 }}"
            {% endif %}
        </blockquote>
        <a href="#response-{{ response.quoted_response.id }}" class="text-xs text-blue-600 hover:text-blue-800 mt-1 inline-block">
            View full response â†’
        </a>
    </div>
    {% endif %}
    
    <!-- Response Content -->
    <div class="response-content text-gray-900 whitespace-pre-wrap" 
         data-response-id="{{ response.id }}" 
         data-author="{{ response.user.username }}"
         data-number="{{ response.response_number }}"
         id="response-{{ response.id }}">{{ response.content }}</div>
    
    <!-- Actions (if user can interact) -->
    {% if can_quote %}
    <div class="mt-3 pt-3 border-t border-gray-100">
        <button 
            onclick="selectQuote({{ response.id }}, '{{ response.content|escapejs }}')"
            class="text-sm text-blue-600 hover:text-blue-800 inline-flex items-center"
        >
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
            </svg>
            Quote this response
        </button>
    </div>
    {% endif %}
</div>

<!-- Quote Popup (hidden by default) -->
<div id="quote-popup" class="hidden fixed bg-white shadow-lg rounded-lg p-3 border border-gray-300 z-50" style="max-width: 200px;">
    <button 
        id="quote-button" 
        class="w-full px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium inline-flex items-center justify-center"
    >
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
        </svg>
        Quote This
    </button>
</div>

<script>
// Enable text selection for quoting
document.addEventListener('DOMContentLoaded', function() {
    enableQuoteSelection();
});

function enableQuoteSelection() {
    const responseContents = document.querySelectorAll('.response-content');
    const popup = document.getElementById('quote-popup');
    const quoteButton = document.getElementById('quote-button');
    
    if (!popup || !quoteButton) return;
    
    responseContents.forEach((element) => {
        element.addEventListener('mouseup', function(e) {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText.length > 0 && selectedText.length <= 500) {
                const responseId = element.getAttribute('data-response-id');
                showQuotePopup(e.pageX, e.pageY, responseId, selectedText);
            } else {
                hideQuotePopup();
            }
        });
    });
    
    // Hide popup when clicking elsewhere
    document.addEventListener('click', function(e) {
        if (!popup.contains(e.target) && !e.target.classList.contains('response-content')) {
            hideQuotePopup();
        }
    });
}

function showQuotePopup(x, y, responseId, text) {
    const popup = document.getElementById('quote-popup');
    const quoteButton = document.getElementById('quote-button');
    
    popup.style.left = x + 'px';
    popup.style.top = (y + 10) + 'px';
    popup.classList.remove('hidden');
    
    quoteButton.onclick = function() {
        insertQuote(responseId, text);
    };
}

function hideQuotePopup() {
    const popup = document.getElementById('quote-popup');
    if (popup) {
        popup.classList.add('hidden');
    }
}

function insertQuote(responseId, text) {
    // Auto-fill quote selector in response form
    const quoteSelector = document.getElementById('quote-selector');
    const quoteTextArea = document.getElementById('quote-text-area');
    
    if (quoteSelector && quoteTextArea) {
        quoteSelector.value = responseId;
        if (typeof showQuotePreview === 'function') {
            showQuotePreview();
        }
        quoteTextArea.value = text;
        
        // Scroll to response form
        const responseForm = document.getElementById('response-form');
        if (responseForm) {
            responseForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Highlight the quote selector briefly
            quoteTextArea.classList.add('ring-2', 'ring-blue-500');
            setTimeout(() => {
                quoteTextArea.classList.remove('ring-2', 'ring-blue-500');
            }, 2000);
        }
    } else {
        // Store in localStorage for navigation
        localStorage.setItem('selectedQuote', JSON.stringify({
            id: responseId,
            text: text
        }));
        window.location.href = "{% url 'discussion-participate' response.round.discussion.id %}";
    }
    
    hideQuotePopup();
}

function selectQuote(responseId, content) {
    insertQuote(responseId, '');  // Quote entire response
}
</script>
