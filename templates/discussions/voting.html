{% extends "base.html" %}
{% load static %}

{% block title %}{{ discussion.topic_headline }} - Voting{% endblock %}

{% block extra_css %}
<style>
.voting-layout {
  max-width: 800px;
  margin: 0 auto;
  padding-bottom: 120px;
}

.voting-header {
  position: sticky;
  top: 0;
  z-index: 10;
  background: white;
  padding: 1rem;
  border-bottom: 1px solid #e5e7eb;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.mrp-timer-large {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 1rem;
  background: #eff6ff;
  border-radius: 8px;
  font-size: 1.25rem;
  font-weight: 600;
  color: #1e40af;
}

.voting-section {
  padding: 1.5rem 1rem;
  border-bottom: 1px solid #e5e7eb;
}

.voting-section h2 {
  margin-bottom: 0.5rem;
  color: #1f2937;
}

.help-text {
  font-size: 0.875rem;
  color: #6b7280;
  margin-bottom: 1rem;
}

.help-text.warning {
  color: #dc2626;
}

.voting-card {
  background: white;
  padding: 1rem;
  margin-bottom: 1rem;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.current-value {
  font-size: 0.875rem;
  color: #374151;
  margin-bottom: 1rem;
}

.vote-options {
  display: flex;
  gap: 0.5rem;
}

.vote-option {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  padding: 1rem;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
}

.vote-option:hover {
  background: #f3f4f6;
  border-color: #3b82f6;
}

.vote-option.selected {
  background: #eff6ff;
  border-color: #3b82f6;
  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}

.vote-option .icon {
  font-size: 1.5rem;
}

.vote-option .label {
  font-size: 0.875rem;
  font-weight: 500;
}

.vote-option .preview {
  font-size: 0.75rem;
  color: #6b7280;
}

.join-request-card {
  border-left: 4px solid #3b82f6;
}

.request-info {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
}

.request-info img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
}

.request-message {
  padding: 0.75rem;
  background: #f9fafb;
  border-radius: 4px;
  margin-bottom: 0.75rem;
  font-size: 0.875rem;
}

.vote-buttons {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.btn-vote {
  flex: 1;
  padding: 0.75rem;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-vote.approve {
  background: #22c55e;
  color: white;
}

.btn-vote.approve:hover:not(:disabled) {
  background: #16a34a;
}

.btn-vote.deny {
  background: #e5e7eb;
  color: #6b7280;
}

.btn-vote.deny:hover:not(:disabled) {
  background: #d1d5db;
}

.btn-vote:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-vote.voted {
  opacity: 0.7;
}

.vote-counts {
  display: flex;
  justify-content: space-around;
  font-size: 0.75rem;
  color: #6b7280;
}

.user-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1rem;
}

.user-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  padding: 1rem;
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
}

.user-card img {
  width: 64px;
  height: 64px;
  border-radius: 50%;
}

.btn-vote-toggle {
  width: 100%;
  padding: 0.5rem;
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-vote-toggle:hover {
  background: #fef2f2;
  border-color: #dc2626;
}

.btn-vote-toggle.selected {
  background: #fee2e2;
  border-color: #dc2626;
  color: #dc2626;
}

.voting-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  padding: 1rem;
  border-top: 1px solid #e5e7eb;
  box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
}

.voting-incentive {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.75rem;
  background: #fef3c7;
  border-radius: 6px;
  margin-bottom: 0.75rem;
  font-size: 0.875rem;
  font-weight: 500;
  color: #92400e;
}

.submit-votes {
  width: 100%;
  padding: 1rem;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  margin-bottom: 0.5rem;
}

.submit-votes:hover {
  background: #2563eb;
}

.skip-voting {
  width: 100%;
  padding: 0.5rem;
  background: none;
  border: none;
  color: #6b7280;
  font-size: 0.875rem;
  cursor: pointer;
}

@media (max-width: 640px) {
  .vote-options {
    flex-direction: column;
  }
  
  .user-grid {
    grid-template-columns: 1fr;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="voting-layout" data-discussion-id="{{ discussion.id }}" data-round-id="{{ current_round.id }}">
  <!-- Voting Header (Sticky) -->
  <div class="voting-header">
    <h1 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">Round {{ current_round.round_number }} Voting</h1>
    <div class="mrp-timer-large">
      <span>‚è±Ô∏è</span>
      <span id="voting-timer">{{ voting_time_remaining }}</span>
      <span style="font-size: 0.875rem; font-weight: normal;">remaining</span>
    </div>
  </div>

  <form id="voting-form">
  <!-- Max Response Length Voting -->
  <div class="voting-section">
    <h2>Maximum Response Length</h2>
    <p class="help-text">Vote to adjust the character limit for next round's responses</p>
    
    <div class="voting-card">
      <div class="current-value">
        Current: <strong>{{ discussion.max_response_length_chars }}</strong> characters
      </div>
      
      <div class="vote-options">
        <button class="vote-option" data-vote-type="mrl" data-vote-value="decrease" onclick="selectVote(this)">
          <span class="icon">üìâ</span>
          <span class="label">Decrease 10%</span>
          <span class="preview">{{ mrl_decrease }}</span>
        </button>
        <button class="vote-option" data-vote-type="mrl" data-vote-value="no_change" onclick="selectVote(this)">
          <span class="icon">‚îÅ</span>
          <span class="label">Keep Same</span>
          <span class="preview">{{ discussion.max_response_length_chars }}</span>
        </button>
        <button class="vote-option" data-vote-type="mrl" data-vote-value="increase" onclick="selectVote(this)">
          <span class="icon">üìà</span>
          <span class="label">Increase 10%</span>
          <span class="preview">{{ mrl_increase }}</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Response Time Multiplier Voting -->
  <div class="voting-section">
    <h2>Response Time Multiplier</h2>
    <p class="help-text">Vote to adjust how much time users have to respond</p>
    
    <div class="voting-card">
      <div class="current-value">
        Current: <strong>{{ discussion.response_time_multiplier }}x</strong>
      </div>
      
      <div class="vote-options">
        <button class="vote-option" data-vote-type="rtm" data-vote-value="decrease" onclick="selectVote(this)">
          <span class="icon">‚è©</span>
          <span class="label">Decrease 10%</span>
          <span class="preview">{{ rtm_decrease }}x</span>
        </button>
        <button class="vote-option" data-vote-type="rtm" data-vote-value="no_change" onclick="selectVote(this)">
          <span class="icon">‚îÅ</span>
          <span class="label">Keep Same</span>
          <span class="preview">{{ discussion.response_time_multiplier }}x</span>
        </button>
        <button class="vote-option" data-vote-type="rtm" data-vote-value="increase" onclick="selectVote(this)">
          <span class="icon">‚è±Ô∏è</span>
          <span class="label">Increase 10%</span>
          <span class="preview">{{ rtm_increase }}x</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Join Request Voting -->
  {% if join_requests %}
  <div class="voting-section">
    <h2>Join Requests ({{ join_requests|length }})</h2>
    <p class="help-text">Vote to approve users who want to join this discussion. Majority vote required.</p>
    <p class="help-text warning">‚ö†Ô∏è Your votes are private and won't be shown to other users</p>
    
    {% for request in join_requests %}
    <div class="voting-card join-request-card">
      <div class="request-info">
        <img src="{% static 'img/default-avatar.png' %}" alt="{{ request.requester.username }}">
        <div style="flex: 1;">
          <div style="font-weight: 600;">{{ request.requester.username }}</div>
          <div style="font-size: 0.75rem; color: #6b7280;">{{ request.created_at|timesince }} ago</div>
        </div>
      </div>
      
      {% if request.request_message %}
      <div class="request-message">{{ request.request_message }}</div>
      {% endif %}
      
      <div class="vote-buttons">
        <button class="btn-vote approve" data-request-id="{{ request.id }}" data-vote="approve" onclick="voteJoinRequest(this)">
          ‚úì Approve
        </button>
        <button class="btn-vote deny" data-request-id="{{ request.id }}" data-vote="deny" onclick="voteJoinRequest(this)">
          Skip
        </button>
      </div>
      
      <div class="vote-counts">
        <span id="approve-count-{{ request.id }}">Votes hidden until voting ends</span>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Removal Voting -->
  {% if active_participants %}
  <div class="voting-section">
    <h2>Remove Participants</h2>
    <p class="help-text">Vote to remove participants from the discussion. Majority vote required. Removed users can request to rejoin.</p>
    <p class="help-text warning">‚ö†Ô∏è Your votes are private</p>
    
    <div class="user-grid">
      {% for participant in active_participants %}
      {% if participant.id != user.id %}
      <div class="user-card">
        <img src="{% static 'img/default-avatar.png' %}" alt="{{ participant.username }}">
        <div style="font-weight: 600; text-align: center;">{{ participant.username }}</div>
        <button class="btn-vote-toggle" data-user-id="{{ participant.id }}" onclick="toggleRemovalVote(this)">
          Vote to Remove
        </button>
      </div>
      {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endif %}
  </form>

  <!-- Voting Footer -->
  <div class="voting-footer">
    <div class="voting-incentive">
      <span>üí∞</span>
      <span>Vote to earn +0.2 Platform Invites and +1 Discussion Invite!</span>
    </div>
    
    <button class="submit-votes" onclick="submitAllVotes()">
      Submit All Votes
    </button>
    
    <button class="skip-voting" onclick="skipVoting()">
      Skip voting (no rewards)
    </button>
  </div>
</div>

<script>
const votes = {
  mrl: null,
  rtm: null,
  join_requests: {},
  removal: new Set()
};

function selectVote(button) {
  const voteType = button.dataset.voteType;
  const voteValue = button.dataset.voteValue;
  
  // Clear previous selection
  document.querySelectorAll(`[data-vote-type="${voteType}"]`).forEach(btn => {
    btn.classList.remove('selected');
  });
  
  // Select this option
  button.classList.add('selected');
  votes[voteType] = voteValue;
}

async function voteJoinRequest(button) {
  const requestId = button.dataset.requestId;
  const vote = button.dataset.vote;
  
  // Store vote locally
  votes.join_requests[requestId] = vote;
  
  // Update UI
  const container = button.closest('.voting-card');
  container.querySelectorAll('.btn-vote').forEach(btn => {
    btn.classList.remove('voted');
  });
  button.classList.add('voted');
}

function toggleRemovalVote(button) {
  const userId = button.dataset.userId;
  
  if (votes.removal.has(userId)) {
    votes.removal.delete(userId);
    button.classList.remove('selected');
  } else {
    votes.removal.add(userId);
    button.classList.add('selected');
  }
}

async function submitAllVotes() {
  const discussionId = document.querySelector('.voting-layout').dataset.discussionId;
  const roundId = document.querySelector('.voting-layout').dataset.roundId;
  
  // Validate required votes
  if (!votes.mrl || !votes.rtm) {
    alert('Please vote on both Max Response Length and Response Time Multiplier');
    return;
  }
  
  try {
    // Submit parameter votes
    const paramResponse = await fetch(`/api/discussions/${discussionId}/rounds/{{ current_round.round_number }}/voting/parameters/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({
        mrl_vote: votes.mrl,
        rtm_vote: votes.rtm
      })
    });
    
    if (!paramResponse.ok) {
      throw new Error('Failed to submit parameter votes');
    }
    
    // Submit join request votes
    for (const [requestId, vote] of Object.entries(votes.join_requests)) {
      if (vote === 'approve') {
        await fetch(`/api/discussions/{{ discussion.id }}/vote/join-request/${requestId}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify({ vote: 'approve' })
        });
      }
    }
    
    // Submit removal votes
    if (votes.removal.size > 0) {
      await fetch(`/api/discussions/${discussionId}/rounds/{{ current_round.round_number }}/voting/removal/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
          target_user_ids: Array.from(votes.removal)
        })
      });
    }
    
    alert('Votes submitted! You earned +0.2 Platform Invites and +1 Discussion Invite');
    window.location.href = '{% url "discussion-detail" discussion.id %}';
    
  } catch (error) {
    console.error('Error submitting votes:', error);
    alert('Failed to submit votes. Please try again.');
  }
}

function skipVoting() {
  if (confirm('Skip voting? You won\'t earn invite credits.')) {
    window.location.href = '{% url "dashboard" %}';
  }
}

function updateVotingTimer() {
  const timer = document.getElementById('voting-timer');
  const deadline = new Date('{{ voting_deadline|date:"c" }}');
  const now = new Date();
  const remaining = deadline - now;
  
  if (remaining > 0) {
    const hours = Math.floor(remaining / 3600000);
    const minutes = Math.floor((remaining % 3600000) / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    timer.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  } else {
    timer.textContent = 'Voting Closed';
    document.querySelector('.submit-votes').disabled = true;
  }
}

function getCsrfToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function showNotification(message, type) {
  alert(message);
}

// Update timer every second
setInterval(updateVotingTimer, 1000);
updateVotingTimer();
</script>

{% csrf_token %}
{% endblock %}
