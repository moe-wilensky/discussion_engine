{% extends "base.html" %}
{% load static %}

{% block title %}Submit Response{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6">
        <a href="{% url 'discussion-detail' discussion.id %}" class="text-blue-600 hover:text-blue-800 flex items-center">
            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Discussion
        </a>
    </div>

    <div class="bg-white shadow rounded-lg p-6">
        <h1 class="text-2xl font-bold mb-4">Submit Your Response</h1>
        
        <!-- MRP Timer -->
        {% if mrp_deadline %}
        <div class="mb-6">
            {% include "components/mrp_timer.html" with deadline=mrp_deadline user_id=request.user.id discussion_id=discussion.id %}
        </div>
        {% endif %}

        <form method="post" action="{% url 'discussion-participate' discussion.id %}" id="response-form" hx-post="{% url 'discussion-participate' discussion.id %}" hx-target="#response-result">
            {% csrf_token %}
            
            <!-- Quote Selector -->
            {% if previous_responses %}
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Quote Previous Response (Optional)
                </label>
                {% include "components/quote_selector.html" with responses=previous_responses %}
            </div>
            {% endif %}

            <!-- Response Content -->
            <div class="mb-6">
                <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
                    Your Response
                </label>
                <textarea 
                    name="content" 
                    id="content" 
                    rows="10" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Type your response here..."
                    required
                >{{ draft_content }}</textarea>
                
                <!-- Character Counter -->
                <div class="mt-2 flex justify-between text-sm">
                    <div class="char-counter">
                        <span id="char-count" class="font-medium">0</span> /
                        <span class="text-gray-600">{{ max_length }} characters</span>
                        <span id="char-status" class="ml-3"></span>
                        <span id="auto-save-status" class="ml-3"></span>
                    </div>
                    {% if is_edit %}
                    <div class="text-gray-600 flex items-center gap-4">
                        <div id="edit-budget-display" class="flex items-center">
                            <svg class="w-4 h-4 mr-1 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            <span id="edit-budget">
                                <span id="budget-remaining" class="font-medium text-blue-600">{{ edit_budget }}</span>
                                <span class="text-sm">/ {{ edit_budget }} char budget</span>
                            </span>
                        </div>
                        <div class="text-sm border-l pl-4 border-gray-300">
                            Edit <span class="font-medium">{{ edit_number }}</span> of {{ max_edits }}
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Validation Message -->
                <div id="char-error" class="text-red-600 mt-1 hidden">
                    Minimum {{ min_length }} characters required
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-between items-center">
                <button 
                    type="button" 
                    id="save-draft-btn"
                    class="btn btn-outline"
                    hx-post="{% url 'discussion-participate' discussion.id %}?draft=true"
                    hx-include="#content"
                >
                    Save Draft
                </button>
                
                <button 
                    type="submit" 
                    id="submit-btn"
                    class="btn btn-primary"
                    disabled
                >
                    Submit Response
                </button>
            </div>
        </form>

        <div id="response-result" class="mt-4"></div>
    </div>
</div>

<script>
const contentArea = document.getElementById('content');
const charCount = document.getElementById('char-count');
const charStatus = document.getElementById('char-status');
const charError = document.getElementById('char-error');
const submitBtn = document.getElementById('submit-btn');
const minLength = {{ min_length }};
const maxLength = {{ max_length }};
{% if is_edit %}
const editBudget = {{ edit_budget }};
const originalContent = `{{ original_content|escapejs }}`;
{% endif %}

// Character counter with real-time validation
contentArea.addEventListener('input', function() {
    const length = this.value.length;
    charCount.textContent = length;
    
    // Validation
    if (length < minLength) {
        const remaining = minLength - length;
        charStatus.textContent = `${remaining} more characters needed`;
        charStatus.className = 'ml-3 text-yellow-600';
        charError.classList.remove('hidden');
        submitBtn.disabled = true;
    } else if (length > maxLength) {
        const excess = length - maxLength;
        charStatus.textContent = `${excess} characters over limit`;
        charStatus.className = 'ml-3 text-red-600';
        charError.classList.add('hidden');
        submitBtn.disabled = true;
    } else {
        {% if is_edit %}
        // Check edit budget
        const diff = calculateCharDiff(originalContent, this.value);
        const budgetRemaining = editBudget - diff;
        const budgetRemainingEl = document.getElementById('budget-remaining');

        budgetRemainingEl.textContent = Math.max(0, budgetRemaining);

        // Color code the budget based on remaining amount
        const percentageUsed = (diff / editBudget) * 100;
        if (percentageUsed >= 100) {
            budgetRemainingEl.className = 'font-medium text-red-600';
        } else if (percentageUsed >= 75) {
            budgetRemainingEl.className = 'font-medium text-orange-600';
        } else if (percentageUsed >= 50) {
            budgetRemainingEl.className = 'font-medium text-yellow-600';
        } else {
            budgetRemainingEl.className = 'font-medium text-blue-600';
        }

        if (diff > editBudget) {
            charStatus.textContent = `⚠ Edit budget exceeded by ${diff - editBudget} characters`;
            charStatus.className = 'ml-3 text-red-600 font-semibold';
            charError.classList.add('hidden');
            submitBtn.disabled = true;
        } else {
            charStatus.textContent = '✓ Valid edit';
            charStatus.className = 'ml-3 text-green-600';
            charError.classList.add('hidden');
            submitBtn.disabled = false;
        }
        {% else %}
        charStatus.textContent = '✓ Valid length';
        charStatus.className = 'ml-3 text-green-600';
        charError.classList.add('hidden');
        submitBtn.disabled = false;
        {% endif %}
    }
});

// Trigger on load
contentArea.dispatchEvent(new Event('input'));

// Auto-save with debounce (3 seconds of inactivity)
let autoSaveTimeout = null;
let lastSaveTime = 0;
const AUTO_SAVE_DEBOUNCE = 3000; // 3 seconds
const MIN_SAVE_INTERVAL = 10000; // Don't save more than once per 10 seconds

function performAutoSave() {
    const now = Date.now();
    if (now - lastSaveTime < MIN_SAVE_INTERVAL) {
        console.log('Auto-save throttled');
        return;
    }

    const content = contentArea.value;
    if (content.length === 0) {
        console.log('Auto-save skipped: no content');
        return;
    }

    console.log('Auto-saving draft...');
    lastSaveTime = now;

    // Make API call to save draft
    fetch(`/api/discussions/{{ discussion.id }}/rounds/{{ current_round_number }}/save-draft/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            content: content,
            reason: 'auto_save'
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Draft auto-saved:', data);
        // Show subtle indicator
        const statusIndicator = document.getElementById('auto-save-status');
        if (statusIndicator) {
            statusIndicator.textContent = '✓ Draft saved';
            statusIndicator.className = 'text-xs text-green-600';
            setTimeout(() => {
                statusIndicator.textContent = '';
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Auto-save failed:', error);
        const statusIndicator = document.getElementById('auto-save-status');
        if (statusIndicator) {
            statusIndicator.textContent = '⚠ Auto-save failed';
            statusIndicator.className = 'text-xs text-red-600';
        }
    });
}

// Debounced auto-save on input
contentArea.addEventListener('input', function() {
    // Clear existing timeout
    if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
    }

    // Set new timeout
    autoSaveTimeout = setTimeout(performAutoSave, AUTO_SAVE_DEBOUNCE);
});

{% if is_edit %}
function calculateCharDiff(original, edited) {
    // Simple Levenshtein distance calculation
    const m = original.length;
    const n = edited.length;
    const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
    
    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;
    
    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            if (original[i-1] === edited[j-1]) {
                dp[i][j] = dp[i-1][j-1];
            } else {
                dp[i][j] = Math.min(
                    dp[i-1][j] + 1,    // deletion
                    dp[i][j-1] + 1,    // insertion
                    dp[i-1][j-1] + 1   // substitution
                ) ;
            }
        }
    }
    
    return dp[m][n];
}
{% endif %}

// MRP expiration warning and final save
{% if mrp_deadline %}
const mrpDeadline = new Date('{{ mrp_deadline|date:"c" }}');
let mrpExpired = false;

setInterval(function() {
    const now = new Date();
    const timeRemaining = mrpDeadline - now;

    if (timeRemaining <= 0 && !mrpExpired && contentArea.value.length > 0) {
        mrpExpired = true;
        showToast('MRP has expired! Saving your draft...', 'warning');
        // Force immediate save
        performFinalSave();
    }
}, 60000); // Check every minute
{% endif %}

// Listen for WebSocket events for final save
if (window.discussionWS) {
    // Override the handleMRPExpired method to trigger final save
    const originalHandleMRPExpired = window.discussionWS.handleMRPExpired;
    window.discussionWS.handleMRPExpired = function(data) {
        console.log('MRP expired event received - performing final save');
        if (contentArea && contentArea.value.length > 0) {
            performFinalSave();
        }
        // Call original handler
        originalHandleMRPExpired.call(window.discussionWS, data);
    };

    // Also listen for round_ended events
    const originalHandleRoundEnded = window.discussionWS.handleRoundEnded;
    window.discussionWS.handleRoundEnded = function(data) {
        console.log('Round ended event received - performing final save');
        if (contentArea && contentArea.value.length > 0) {
            performFinalSave();
        }
        // Call original handler
        originalHandleRoundEnded.call(window.discussionWS, data);
    };
}

function performFinalSave() {
    const content = contentArea.value;
    if (content.length === 0) {
        return;
    }

    console.log('Performing final save before MRP expiration/round end...');

    // Make synchronous API call to ensure save completes
    const xhr = new XMLHttpRequest();
    xhr.open('POST', `/api/discussions/{{ discussion.id }}/rounds/{{ current_round_number }}/save-draft/`, false); // false = synchronous
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');

    try {
        xhr.send(JSON.stringify({
            content: content,
            reason: 'mrp_expired'
        }));

        if (xhr.status === 201) {
            console.log('Final save successful');
            showToast('Your response was saved as a draft', 'success');
        } else {
            console.error('Final save failed:', xhr.status, xhr.responseText);
            showToast('Failed to save draft - please try submitting again', 'error');
        }
    } catch (error) {
        console.error('Final save error:', error);
        showToast('Failed to save draft - please try submitting again', 'error');
    }
}
</script>
{% endblock %}
