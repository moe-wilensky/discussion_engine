{% extends "base.html" %}
{% load static %}

{% block title %}{{ discussion.topic_headline }} - Active{% endblock %}

{% block extra_css %}
<style>
.active-discussion-layout {
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-width: 1200px;
  margin: 0 auto;
}

.global-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  background: white;
  border-bottom: 1px solid #e5e7eb;
}

.action-subheader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 1rem;
  background: #f9fafb;
  border-bottom: 1px solid #e5e7eb;
}

.topic-context {
  position: relative;
  padding: 1rem;
  background: #eff6ff;
  border-bottom: 1px solid #bfdbfe;
}

.topic-context.collapsed .topic-content {
  display: none;
}

.collapse-toggle {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  background: none;
  border: none;
  cursor: pointer;
  padding: 0.5rem;
}

.headline {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  color: #1e40af;
}

.topic {
  color: #1e40af;
  line-height: 1.6;
}

.response-stream {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  background: #f9fafb;
}

.response-card {
  background: white;
  padding: 1rem;
  margin-bottom: 1rem;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.response-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

.author-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.author-info img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
}

.username {
  font-weight: 600;
}

.timestamp {
  font-size: 0.875rem;
  color: #6b7280;
}

.quoted-response {
  background: #f3f4f6;
  padding: 0.75rem;
  margin-bottom: 0.75rem;
  border-left: 3px solid #3b82f6;
  border-radius: 4px;
}

.quote-author {
  font-size: 0.875rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.25rem;
}

.quote-text {
  font-size: 0.875rem;
  color: #6b7280;
}

.response-content {
  line-height: 1.6;
  color: #1f2937;
  white-space: pre-wrap;
}

.quote-btn {
  background: #eff6ff;
  color: #2563eb;
  border: 1px solid #3b82f6;
  padding: 0.25rem 0.75rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.875rem;
}

.composer-footer {
  background: white;
  padding: 1rem;
  border-top: 1px solid #e5e7eb;
}

.constraint-feedback-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem;
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  margin-bottom: 1rem;
}

.mrp-timer {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.mrp-timer.warning {
  color: #dc2626;
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.length-counter {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.length-counter.over-limit .current {
  color: #dc2626;
  font-weight: 600;
}

.input-area {
  position: relative;
  margin-bottom: 1rem;
}

#response-input {
  width: 100%;
  min-height: 120px;
  padding: 0.75rem;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-family: inherit;
  font-size: 1rem;
  resize: vertical;
}

#response-input:focus {
  outline: none;
  border-color: #2563eb;
}

.active-quote {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  padding: 0.5rem 1rem;
  background: #eff6ff;
  border: 1px solid #3b82f6;
  border-radius: 4px;
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: #1e40af;
}

.clear-quote {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.25rem;
  color: #6b7280;
}

.submit-response {
  width: 100%;
  padding: 1rem;
  background: #22c55e;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  transition: all 0.2s;
}

.submit-response:hover:not(:disabled) {
  background: #16a34a;
}

.submit-response:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.submit-response .cost {
  font-size: 0.875rem;
  opacity: 0.8;
}
</style>
{% endblock %}

{% block content %}
<div class="active-discussion-layout" data-discussion-id="{{ discussion.id }}">
  <!-- Global Header -->
  <div class="global-header">
    <div>
      <button onclick="window.location.href='{% url 'dashboard' %}'" style="background: none; border: none; cursor: pointer; font-size: 1.25rem;">←</button>
    </div>
    <div style="font-weight: 600;">Round {{ current_round.round_number }}</div>
    <div style="display: flex; gap: 0.5rem;">
      <div style="font-size: 0.875rem; color: #6b7280;">
        {{ user.discussion_invites_banked|floatformat:0 }} credits
      </div>
    </div>
  </div>

  <!-- Action Subheader -->
  <div class="action-subheader">
    <div style="font-size: 0.875rem; color: #6b7280;">
      {{ participant_status }}
    </div>
    <div style="display: flex; gap: 0.5rem;">
      <button onclick="switchToObserver()" style="padding: 0.25rem 0.75rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
        Observer
      </button>
      <button onclick="leaveDiscussion()" style="padding: 0.25rem 0.75rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
        Leave
      </button>
    </div>
  </div>

  <!-- Topic Context (Collapsible) -->
  <div class="topic-context" id="topic-context">
    <button class="collapse-toggle" onclick="toggleTopic()">▼</button>
    <div class="topic-content">
      <div class="headline">{{ discussion.topic_headline }}</div>
      <div class="topic">{{ discussion.topic_details }}</div>
    </div>
  </div>

  <!-- Response Stream -->
  <div class="response-stream" id="response-stream">
    {% for response in responses %}
    <div class="response-card">
      <div class="response-header">
        <div class="author-info">
          <img src="{% static 'img/default-avatar.png' %}" alt="{{ response.user.username }}">
          <div>
            <div class="username">{{ response.user.username }}</div>
            <div class="timestamp">{{ response.created_at|timesince }} ago</div>
          </div>
        </div>
        <button class="quote-btn" onclick="quoteResponse('{{ response.id }}', '{{ response.user.username|escapejs }}', '{{ response.content|escapejs }}')">
          Quote
        </button>
      </div>
      
      {% if response.quoted_response %}
      <div class="quoted-response">
        <div class="quote-author">@{{ response.quoted_response.user.username }}</div>
        <div class="quote-text">{{ response.quoted_response.content|truncatewords:30 }}</div>
      </div>
      {% endif %}
      
      <div class="response-content">{{ response.content }}</div>
    </div>
    {% endfor %}
  </div>

  <!-- Composer Footer -->
  <div class="composer-footer">
    <!-- Constraint Feedback -->
    <div class="constraint-feedback-bar">
      <div class="mrp-timer" id="mrp-timer-display">
        <span>⏰</span>
        <span id="mrp-timer">{{ mrp_time_remaining }}</span>
      </div>
      <div class="length-counter" id="length-counter">
        <span class="current">0</span>
        <span>/</span>
        <span class="max">{{ discussion.max_response_length_chars }}</span>
      </div>
    </div>

    <!-- Input Area -->
    <div class="input-area">
      <textarea id="response-input" placeholder="Type your response..." oninput="updateCharCount()"></textarea>
      <div id="active-quote-indicator" style="display: none;" class="active-quote">
        <span id="quote-author"></span>
        <button class="clear-quote" onclick="clearQuote()">×</button>
      </div>
    </div>

    <!-- Submit Button -->
    <button class="submit-response" id="submit-btn" onclick="submitResponse()" disabled>
      <span>Submit Response</span>
      <span class="cost">(-1 credit)</span>
    </button>
  </div>
</div>

<script>
let quotedResponseId = null;
let quotedAuthor = null;
const maxLength = {{ discussion.max_response_length_chars }};
const mrpDeadline = new Date('{{ mrp_deadline|date:"c" }}');

function updateCharCount() {
  const input = document.getElementById('response-input');
  const counter = document.getElementById('length-counter');
  const submitBtn = document.getElementById('submit-btn');
  const current = input.value.length;
  
  counter.querySelector('.current').textContent = current;
  
  if (current > maxLength) {
    counter.classList.add('over-limit');
    submitBtn.disabled = true;
  } else if (current === 0) {
    counter.classList.remove('over-limit');
    submitBtn.disabled = true;
  } else {
    counter.classList.remove('over-limit');
    submitBtn.disabled = false;
  }
}

function updateMRPTimer() {
  const timer = document.getElementById('mrp-timer');
  const timerDisplay = document.getElementById('mrp-timer-display');
  const now = new Date();
  const remaining = mrpDeadline - now;
  
  if (remaining > 0) {
    const hours = Math.floor(remaining / 3600000);
    const minutes = Math.floor((remaining % 3600000) / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    timer.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Warning if less than 10 minutes
    if (remaining < 600000) {
      timerDisplay.classList.add('warning');
    }
  } else {
    timer.textContent = 'Expired';
    timerDisplay.classList.add('warning');
  }
}

function quoteResponse(responseId, author, text) {
  quotedResponseId = responseId;
  quotedAuthor = author;
  
  const indicator = document.getElementById('active-quote-indicator');
  indicator.style.display = 'flex';
  document.getElementById('quote-author').textContent = `@${author}`;
  
  document.getElementById('response-input').focus();
}

function clearQuote() {
  quotedResponseId = null;
  quotedAuthor = null;
  document.getElementById('active-quote-indicator').style.display = 'none';
}

async function submitResponse() {
  const input = document.getElementById('response-input');
  const text = input.value.trim();
  
  if (!text || text.length > maxLength) {
    return;
  }
  
  const data = {
    response_text: text,
    quoted_response_id: quotedResponseId
  };
  
  try {
    const response = await fetch(`/api/discussions/{{ discussion.id }}/respond/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify(data)
    });
    
    if (response.ok) {
      // Clear input and reload
      input.value = '';
      clearQuote();
      updateCharCount();
      window.location.reload();
    } else {
      const error = await response.json();
      alert(error.error || 'Failed to submit response');
    }
  } catch (error) {
    console.error('Error submitting response:', error);
    alert('Network error. Please try again.');
  }
}

function toggleTopic() {
  document.getElementById('topic-context').classList.toggle('collapsed');
}

function switchToObserver() {
  if (confirm('Switch to observer mode? You won\'t be able to post responses.')) {
    fetch(`/api/discussions/{{ discussion.id }}/switch-to-observer/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCsrfToken()
      }
    })
    .then(() => window.location.reload());
  }
}

function leaveDiscussion() {
  if (confirm('Leave this discussion?')) {
    window.location.href = '{% url "dashboard" %}';
  }
}

function getCsrfToken() {
  const input = document.querySelector('[name=csrfmiddlewaretoken]');
  if (input) return input.value;
  // Fallback: read from cookie
  const cookie = document.cookie.split('; ').find(c => c.startsWith('csrftoken='));
  return cookie ? cookie.split('=')[1] : '';
}

// Update MRP timer every second
setInterval(updateMRPTimer, 1000);
updateMRPTimer();

// Auto-scroll to bottom of response stream
document.getElementById('response-stream').scrollTop = 
  document.getElementById('response-stream').scrollHeight;
</script>

{% csrf_token %}
{% endblock %}
