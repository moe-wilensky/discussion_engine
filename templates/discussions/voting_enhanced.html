{% extends "base.html" %}
{% load static %}

{% block title %}Vote on Changes{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6">
        <a href="{% url 'discussion-detail' discussion.id %}" class="text-blue-600 hover:text-blue-800 flex items-center">
            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Discussion
        </a>
    </div>

    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h1 class="text-2xl font-bold mb-2">Inter-Round Voting</h1>
        <p class="text-gray-600 mb-4">Vote on parameter changes and moderation actions for the next round.</p>

        <!-- Voting Window Timer -->
        {% if voting_deadline %}
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                </svg>
                <span class="text-blue-800 font-medium">Voting closes in <span id="voting-countdown" class="font-bold">...</span></span>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Section 1: Parameter Voting -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
            <span class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm">1</span>
            Parameter Voting
        </h2>
        <p class="text-sm text-gray-600 mb-6 ml-11">Vote on proposed changes to discussion parameters for the next round.</p>

        <form method="post" id="parameter-voting-form" action="{% url 'api:cast_vote' discussion.id current_round.round_number %}" class="ml-11">
            {% csrf_token %}

            <div class="space-y-6">
                <!-- Max Response Length -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="font-medium mb-2">Maximum Response Length (MRL)</h3>
                    <div class="text-sm text-gray-600 mb-4">
                        Current: <span class="font-semibold">{{ current_params.max_response_length_chars }}</span> characters
                    </div>

                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="mrl_vote" value="increase" class="mr-2">
                            <span>Increase</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="mrl_vote" value="no_change" class="mr-2" checked>
                            <span>No Change</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="mrl_vote" value="decrease" class="mr-2">
                            <span>Decrease</span>
                        </label>
                    </div>

                    <div class="mt-2 text-xs text-gray-500">
                        Note: Not voting counts as "no change". {{ vote_threshold }}% of {{ eligible_voters }} eligible voters must agree for change to pass.
                    </div>
                </div>

                <!-- Response Time Multiplier -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="font-medium mb-2">Response Time Multiplier (RTM)</h3>
                    <div class="text-sm text-gray-600 mb-4">
                        Current: <span class="font-semibold">{{ current_params.response_time_multiplier }}</span>
                    </div>

                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="rtm_vote" value="increase" class="mr-2">
                            <span>Increase</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="rtm_vote" value="no_change" class="mr-2" checked>
                            <span>No Change</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="rtm_vote" value="decrease" class="mr-2">
                            <span>Decrease</span>
                        </label>
                    </div>
                </div>
            </div>

            <button type="submit" class="mt-6 btn btn-primary">
                Submit Parameter Votes
            </button>
        </form>
    </div>

    <!-- Section 2: Removal Voting -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
            <span class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm">2</span>
            Removal Voting
        </h2>
        <div class="ml-11">
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <p class="text-sm text-red-800">
                    <strong>⚠️ Warning:</strong> Removal voting is a serious moderation action.
                    Vote to remove participants who are consistently disruptive or violating community standards.
                    Removed participants become permanent observers and cannot rejoin this discussion.
                </p>
                <p class="text-sm text-red-700 mt-2">
                    Removal requires <strong>{{ removal_threshold }}%</strong> agreement from eligible voters.
                </p>
            </div>

            {% if removal_eligible_participants %}
            <div class="space-y-4">
                {% for participant in removal_eligible_participants %}
                <div class="border border-gray-300 rounded-lg p-4 hover:border-gray-400 transition">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-medium text-lg">{{ participant.username }}</h3>
                            <p class="text-sm text-gray-600">{{ participant.response_count }} responses in this discussion</p>
                            {% if participant.removal_count > 0 %}
                            <p class="text-xs text-orange-600 mt-1">Previously removed {{ participant.removal_count }} time(s)</p>
                            {% endif %}
                        </div>

                        <div class="text-right">
                            <div class="text-sm font-medium" id="removal-votes-{{ participant.id }}">
                                Current votes: <span class="vote-count">0</span> / {{ eligible_voters }}
                            </div>
                            <div class="text-xs text-gray-500 mt-1" id="removal-percentage-{{ participant.id }}">
                                (<span class="vote-percentage">0</span>%)
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button
                            type="button"
                            class="removal-vote-btn flex-1 py-2 px-4 border-2 border-red-500 text-red-500 rounded-lg hover:bg-red-50 transition font-medium"
                            data-participant-id="{{ participant.id }}"
                            data-action="remove"
                            onclick="castRemovalVote({{ participant.id }}, 'remove', this)"
                        >
                            Vote to Remove
                        </button>
                        <button
                            type="button"
                            class="removal-vote-btn flex-1 py-2 px-4 border-2 border-green-500 text-green-500 rounded-lg hover:bg-green-50 transition font-medium"
                            data-participant-id="{{ participant.id }}"
                            data-action="keep"
                            onclick="castRemovalVote({{ participant.id }}, 'keep', this)"
                        >
                            Vote to Keep
                        </button>
                    </div>

                    <div class="mt-3 text-xs text-gray-500">
                        <span id="removal-status-{{ participant.id }}"></span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-500">
                <p>No participants eligible for removal voting at this time.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Voting Instructions -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="text-sm text-gray-600">
            <p class="font-medium mb-2">⚠️ Important Voting Rules:</p>
            <ul class="list-disc list-inside space-y-1 ml-2">
                <li><strong>Parameter votes</strong> are submitted together and cannot be changed after submission</li>
                <li><strong>Removal votes</strong> are cast immediately and update in real-time</li>
                <li>Abstaining (not voting) counts as "no change" for parameter votes</li>
                <li>Voting window closes in <span id="deadline-display" class="font-semibold">...</span></li>
            </ul>
        </div>
    </div>
</div>

<script>
// Countdown timer
{% if voting_deadline %}
const votingDeadline = new Date('{{ voting_deadline|date:"c" }}');

function updateCountdown() {
    const now = new Date();
    const remaining = votingDeadline - now;

    if (remaining <= 0) {
        document.getElementById('voting-countdown').textContent = 'EXPIRED';
        document.getElementById('deadline-display').textContent = 'EXPIRED';
        return;
    }

    const hours = Math.floor(remaining / (1000 * 60 * 60));
    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);

    const display = `${hours}h ${minutes}m ${seconds}s`;
    document.getElementById('voting-countdown').textContent = display;
    document.getElementById('deadline-display').textContent = display;
}

setInterval(updateCountdown, 1000);
updateCountdown();
{% endif %}

// Removal voting
const userRemovalVotes = {}; // Track user's votes

function castRemovalVote(participantId, action, button) {
    // Check if user already voted for this participant
    if (userRemovalVotes[participantId]) {
        if (userRemovalVotes[participantId] === action) {
            alert('You have already cast this vote.');
            return;
        }
    }

    // Disable all buttons for this participant during API call
    const buttons = document.querySelectorAll(`[data-participant-id="${participantId}"]`);
    buttons.forEach(btn => btn.disabled = true);

    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Make API call
    fetch(`/api/discussions/{{ discussion.id }}/rounds/{{ current_round.round_number }}/voting/removal/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({
            targets: [participantId],
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            buttons.forEach(btn => btn.disabled = false);
            return;
        }

        // Record the vote
        userRemovalVotes[participantId] = action;

        // Update button states
        buttons.forEach(btn => {
            btn.disabled = false;
            if (btn.dataset.action === action) {
                btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.remove('text-red-500', 'text-green-500');
            }
        });

        // Fetch updated vote counts
        fetchRemovalResults();

        // Show success message
        document.getElementById(`removal-status-${participantId}`).innerHTML =
            `<span class="text-green-600">✓ Your vote has been recorded</span>`;
    })
    .catch(error => {
        console.error('Error casting removal vote:', error);
        alert('Failed to cast vote. Please try again.');
        buttons.forEach(btn => btn.disabled = false);
    });
}

function fetchRemovalResults() {
    fetch(`/api/discussions/{{ discussion.id }}/rounds/{{ current_round.round_number }}/voting/removal-results/`)
        .then(response => response.json())
        .then(data => {
            if (data.targets) {
                data.targets.forEach(target => {
                    const voteCountElem = document.querySelector(`#removal-votes-${target.user_id} .vote-count`);
                    const votePercentageElem = document.querySelector(`#removal-percentage-${target.user_id} .vote-percentage`);

                    if (voteCountElem) {
                        voteCountElem.textContent = target.votes_for_removal;
                    }
                    if (votePercentageElem) {
                        votePercentageElem.textContent = target.percentage.toFixed(1);
                    }

                    // Update status message
                    const statusElem = document.getElementById(`removal-status-${target.user_id}`);
                    if (statusElem && target.will_be_removed) {
                        statusElem.innerHTML = '<span class="text-red-600">⚠️ This participant will be removed</span>';
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error fetching removal results:', error);
        });
}

// Fetch removal results on page load and every 10 seconds
{% if removal_eligible_participants %}
fetchRemovalResults();
setInterval(fetchRemovalResults, 10000);
{% endif %}

// WebSocket for live updates
const ws = new WebSocket(`ws://${window.location.host}/ws/discussion/{{ discussion.id }}/`);

ws.onmessage = function(event) {
    const data = JSON.parse(event.data);

    if (data.type === 'voting_updated') {
        fetchRemovalResults();
    }
};

ws.onerror = function(error) {
    console.error('WebSocket error:', error);
};
</script>
{% endblock %}
